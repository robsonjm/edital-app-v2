<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0516349490877138" crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edital App V2 | Gamified</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    },
                    typography: (theme) => ({
                        invert: {
                            css: {
                                '--tw-prose-body': theme('colors.gray[300]'),
                                '--tw-prose-headings': theme('colors.white'),
                                '--tw-prose-links': theme('colors.blue[400]'),
                                '--tw-prose-bold': theme('colors.white'),
                                '--tw-prose-counters': theme('colors.blue[400]'),
                                '--tw-prose-bullets': theme('colors.blue[400]'),
                                '--tw-prose-hr': theme('colors.gray[700]'),
                                '--tw-prose-quotes': theme('colors.gray[100]'),
                                '--tw-prose-quote-borders': theme('colors.blue[500]'),
                                '--tw-prose-th-borders': theme('colors.gray[600]'),
                                '--tw-prose-td-borders': theme('colors.gray[700]'),
                            },
                        },
                    }),
                }
            },
            plugins: [
                function({ addComponents }) {
                    addComponents({
                        '.glass': {
                            'background': 'rgba(255, 255, 255, 0.05)',
                            'backdrop-filter': 'blur(10px)',
                            'border': '1px solid rgba(255, 255, 255, 0.1)',
                        },
                        '.glass-card': {
                            'background': 'rgba(17, 24, 39, 0.7)',
                            'backdrop-filter': 'blur(20px)',
                            'border': '1px solid rgba(255, 255, 255, 0.05)',
                        }
                    })
                }
            ]
        }<script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Supress PDF.js Font warnings
        const origConsoleWarn = console.warn;
        console.warn = function(...args) {
             if(args[0] && typeof args[0] === 'string' && args[0].includes('Warning: TT:')) return;
             origConsoleWarn.apply(console, args);
        };
    </script>
    <script type="importmap">
      {
        "imports": {
          "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
          "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"
        }
      }
    </script>
    <style>
        body { font-family: 'Outfit', sans-serif; }
    </style>
</head>
<body class="bg-[#0f172a] text-gray-100 min-h-screen relative overflow-x-hidden selection:bg-purple-500 selection:text-white">

    <!-- Background Elements -->
    <div class="fixed inset-0 z-0 overflow-hidden pointer-events-none">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-8 left-1/3 w-96 h-96 bg-pink-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-all duration-500">
        <div class="glass-card p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-100 border-t border-white/10">
            <div class="text-center mb-8">
                <div class="inline-block p-3 rounded-full bg-blue-500/10 mb-4">
                    <span class="text-4xl">üöÄ</span>
                </div>
                <h2 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">Bem-vindo</h2>
                <p class="text-gray-400 mt-2">Sua jornada rumo √† aprova√ß√£o come√ßa aqui.</p>
            </div>
            
            <button id="googleLoginBtn" class="w-full bg-white hover:bg-gray-50 text-gray-900 font-bold py-3.5 px-4 rounded-xl mb-6 flex items-center justify-center gap-3 transition-all hover:scale-[1.02] shadow-lg shadow-white/5">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                Continuar com Google
            </button>

            <div class="relative my-8">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-700"></div></div>
                <div class="relative flex justify-center text-xs uppercase tracking-widest"><span class="px-3 bg-[#131b2e] text-gray-500">Ou entre com email</span></div>
            </div>

            <form id="emailForm" class="space-y-4">
                <div class="group">
                    <input type="email" id="emailInput" placeholder="seu@email.com" class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3.5 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all" required>
                </div>
                <div>
                    <input type="password" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3.5 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all" required>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-blue-900/30 hover:shadow-blue-900/50 transition-all hover:scale-[1.02]">
                    Entrar / Criar Conta
                </button>
            </form>
            <p id="loginError" class="text-red-400 text-sm mt-4 text-center hidden bg-red-900/20 py-2 rounded-lg border border-red-900/30"></p>
        </div>
    </div>

    <!-- App Container -->
    <div class="relative z-10 flex flex-col md:flex-row h-screen overflow-hidden pt-4 pb-4 px-4 gap-6 max-w-7xl mx-auto">
        
        <!-- Sidebar (Meus Editais) -->
        <aside class="w-full md:w-80 glass-card rounded-2xl flex flex-col hidden md:flex shrink-0">
            <!-- Header -->
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Meus Editais</h2>
                <span class="text-xs bg-blue-500/20 text-blue-300 px-2 py-1 rounded-md border border-blue-500/30" id="editaisCount">0</span>
            </div>
            <!-- List -->
            <div id="editalList" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent">
                <!-- Items injected here -->
                <div class="text-center text-gray-500 mt-10">
                    <p>Nenhum edital salvo.</p>
                </div>
            </div>
            <!-- Footer -->
            <div class="p-4 border-t border-white/10">
                 <button onclick="document.getElementById('fileInput').click()" class="w-full py-3 rounded-xl bg-blue-600/20 hover:bg-blue-600/40 text-blue-300 font-bold border border-blue-500/30 transition-all flex items-center justify-center gap-2">
                    <span>+</span> Novo Edital
                 </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto scrollbar-hide w-full">
            
            <!-- Mobile Menu Toggle -->
            <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('z-50'); document.querySelector('aside').classList.toggle('h-[90%]');" class="md:hidden mb-4 glass px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                üìÇ Meus Editais
            </button>

            <!-- Header -->
            <header class="flex justify-between items-center mb-8 glass rounded-2xl p-4 sticky top-0 z-40 shadow-xl shadow-black/20 transition-all duration-300 backdrop-blur-xl">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xl shadow-lg">
                    üìö
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Edital App</h1>
                    <span class="text-xs text-blue-400 font-medium tracking-wide">V2.0 PRO</span>
                </div>
            </div>

            <!-- User Stats (Gamification) -->
            <div id="userHeader" class="hidden flex items-center gap-6">
                <div class="hidden md:flex items-center gap-4 bg-gray-800/50 px-4 py-2 rounded-xl border border-white/5">
                    <div class="flex flex-col items-end">
                        <span class="text-xs text-gray-400 uppercase tracking-wider">N√≠vel 1</span>
                        <div class="w-24 h-1.5 bg-gray-700 rounded-full mt-1 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-yellow-400 to-orange-500 w-[30%]"></div>
                        </div>
                    </div>
                    <div class="w-px h-8 bg-gray-700"></div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400">XP</div>
                        <div class="font-bold text-yellow-400">350</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-xs font-bold ring-2 ring-gray-900" id="userAvatar">U</div>
                    <button id="logoutBtn" class="text-sm text-gray-400 hover:text-white transition-colors">Sair</button>
                </div>
            </div>
        </header>

        <!-- Main Content (Wrapper removed) -->
        <div class="space-y-8">
            
            <!-- Upload Section -->
            <section class="glass-card rounded-3xl p-1 text-center relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 opacity-50 group-hover:opacity-100 transition-opacity"></div>
                
                <div class="p-8 sm:p-12">
                    <h2 class="text-3xl sm:text-4xl font-bold mb-4">O que vamos estudar hoje?</h2>
                    <p class="text-gray-400 mb-8 max-w-lg mx-auto">Fa√ßa upload do seu edital em PDF e deixe nossa IA criar um plano de estudos personalizado ou um quiz desafiador.</p>
                    
                    <div class="max-w-xl mx-auto relative group/input">
                        <input type="file" id="fileInput" accept="application/pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                        <div class="border-2 border-dashed border-gray-600 rounded-2xl p-8 transition-all group-hover/input:border-blue-500 group-hover/input:bg-blue-500/5">
                            <div class="flex flex-col items-center gap-3">
                                <div class="w-16 h-16 rounded-full bg-gray-800 flex items-center justify-center mb-2 group-hover/input:scale-110 transition-transform">
                                    <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                </div>
                                <span class="font-semibold text-lg text-gray-200">Arraste seu PDF aqui</span>
                                <span class="text-sm text-gray-500">ou clique para selecionar</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons Removed - Replaced by Auto-Analysis -->
                    
                    <!-- Loading State -->
                    <div id="status" class="hidden mt-8 max-w-md mx-auto">
                        <div class="flex justify-between text-sm text-blue-300 mb-2">
                            <span id="statusText">Analisando Edital...</span>
                            <span class="animate-pulse">IA trabalhando</span>
                        </div>
                        <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500 animate-progress w-full origin-left-right"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Contest Dashboard (Hidden initially) -->
            <section id="contestDashboard" class="hidden animate-fade-in-up">
                
                <!-- Tabs Nav -->
                <div class="glass-card rounded-2xl p-2 mb-8 flex flex-wrap sm:flex-nowrap gap-2 sticky top-24 z-30 backdrop-blur-xl">
                    <button onclick="switchTab('visao-geral')" id="tab-visao-geral" class="tab-btn active w-full py-3 px-6 rounded-xl font-bold transition-all text-white bg-blue-600 shadow-lg shadow-blue-900/20">
                        üìä Vis√£o Geral
                    </button>
                    <button onclick="switchTab('plano-estudos')" id="tab-plano-estudos" class="tab-btn w-full py-3 px-6 rounded-xl font-bold transition-all text-gray-400 hover:text-white hover:bg-white/5">
                        üìÖ Plano de Estudos
                    </button>
                    <button onclick="switchTab('treino')" id="tab-treino" class="tab-btn w-full py-3 px-6 rounded-xl font-bold transition-all text-gray-400 hover:text-white hover:bg-white/5">
                        üß† Treino
                    </button>
                </div>

                <!-- Tab: Vis√£o Geral -->
                <div id="panel-visao-geral" class="tab-panel space-y-6">
                    <!-- Title Card -->
                    <div class="glass-card p-8 rounded-3xl border border-white/10 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl -mr-16 -mt-16"></div>
                        <h2 id="dash-nome" class="text-3xl font-bold text-white mb-4 relative z-10">Analisando...</h2>
                        <div class="flex flex-wrap gap-4 text-sm relative z-10">
                            <span id="dash-banca" class="px-4 py-2 rounded-lg bg-blue-500/20 text-blue-300 border border-blue-500/30 font-semibold">Banca: ...</span>
                            <span id="dash-vagas" class="px-4 py-2 rounded-lg bg-purple-500/20 text-purple-300 border border-purple-500/30 font-semibold">Vagas: ...</span>
                            <span id="dash-salario" class="px-4 py-2 rounded-lg bg-green-500/20 text-green-300 border border-green-500/30 font-semibold">R$ ...</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <!-- Etapas -->
                        <div class="glass-card p-6 rounded-3xl border border-white/10">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">üöÄ Etapas</h3>
                            <ul id="dash-etapas" class="space-y-3 text-gray-300"></ul>
                        </div>
                        <!-- Mat√©rias -->
                        <div class="glass-card p-6 rounded-3xl border border-white/10">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">üìö Mat√©rias</h3>
                            <div id="dash-materias" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Plano de Estudos -->
                <div id="panel-plano-estudos" class="tab-panel hidden space-y-6">
                    <div class="glass-card p-8 rounded-3xl text-center border border-white/10">
                         <h3 class="text-2xl font-bold mb-4">Seu Cronograma Personalizado</h3>
                         <p class="text-gray-400 mb-6">A IA criar√° um plano semanal baseado no seu edital.</p>
                         <button onclick="chamarBackend('plano')" class="px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition-all shadow-lg shadow-blue-900/30 hover:scale-105">
                            Gerar Novo Plano
                         </button>
                    </div>
                    
                    <!-- √Årea Espec√≠fica para o Plano -->
                    <div id="planoResult" class="hidden glass-card rounded-3xl p-8 sm:p-12 border border-white/10 shadow-2xl animate-fade-in-up">
                        <div class="prose prose-invert prose-lg max-w-none prose-headings:text-blue-300 prose-a:text-blue-400 prose-strong:text-white"></div>
                    </div>
                </div>

                <!-- Tab: Treino -->
                <div id="panel-treino" class="tab-panel hidden space-y-6">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <button onclick="chamarBackend('quiz')" class="glass-card p-8 rounded-3xl text-left border border-white/10 hover:border-purple-500/50 transition-all group hover:scale-[1.02]">
                            <span class="text-4xl mb-4 block">üß†</span>
                            <h3 class="text-2xl font-bold text-white group-hover:text-purple-400 transition-colors">Quiz R√°pido</h3>
                            <p class="text-gray-400 mt-2">5 quest√µes para testar seus conhecimentos agora.</p>
                        </button>
                        
                        <button onclick="chamarBackend('simulado_real')" class="glass-card p-8 rounded-3xl text-left border border-white/10 hover:border-red-500/50 transition-all group hover:scale-[1.02]">
                            <span class="text-4xl mb-4 block">üéì</span>
                            <h3 class="text-2xl font-bold text-white group-hover:text-red-400 transition-colors">Simulado Real</h3>
                            <p class="text-gray-400 mt-2">Experi√™ncia completa de prova com timer e corre√ß√£o.</p>
                        </button>
                     </div>
                </div>

            </section>

            <!-- Results Section -->
            <section id="resultadoArea" class="hidden glass-card rounded-3xl p-8 sm:p-12 border border-white/10 shadow-2xl animate-fade-in-up">
                <div class="prose prose-invert prose-lg max-w-none prose-headings:text-blue-300 prose-a:text-blue-400 prose-strong:text-white">
                    <!-- Markdown content goes here -->
                </div>
            </section>

            <!-- Simulado Real Section -->
            <section id="simuladoArea" class="hidden glass-card rounded-3xl p-6 sm:p-8 border border-white/10 shadow-2xl animate-fade-in-up relative">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                    <div>
                        <h2 id="simuladoTitle" class="text-2xl font-bold text-white">Simulado</h2>
                        <span id="simuladoSubject" class="text-sm text-blue-400 font-semibold uppercase tracking-wider">Geral</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="bg-gray-800 px-4 py-2 rounded-lg border border-gray-700 flex items-center gap-2">
                            <span>‚è±Ô∏è</span>
                            <span id="timerDisplay" class="font-mono text-xl font-bold text-yellow-400">00:00</span>
                        </div>
                        <div class="text-sm text-gray-400">
                            Quest√£o <span id="currentQuestionNum" class="text-white font-bold">1</span> de <span id="totalQuestionsNum">10</span>
                        </div>
                    </div>
                </div>

                <!-- Question Container -->
                <div id="questionContainer" class="mb-8 min-h-[200px]">
                    <p id="questionText" class="text-lg text-gray-200 mb-6 leading-relaxed"></p>
                    <div id="optionsContainer" class="space-y-3">
                        <!-- Options injected here -->
                    </div>
                </div>

                <!-- Footer / Navigation -->
                <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-700">
                    <button id="prevBtn" class="px-6 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        ‚Üê Anterior
                    </button>
                    <button id="submitSimuladoBtn" class="hidden px-8 py-3 rounded-xl bg-green-600 hover:bg-green-700 text-white font-bold shadow-lg shadow-green-900/30 transition-all hover:scale-105">
                        Finalizar Simulado
                    </button>
                    <button id="nextBtn" class="px-6 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg shadow-blue-900/30 transition-all hover:scale-105">
                        Pr√≥xima ‚Üí
                    </button>
                </div>
            </section>
        </div>
    </main>
    </div>

    <!-- Existing Scripts preserved and enhanced -->
    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "firebase/auth";
        import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, getDocs, doc, deleteDoc, setDoc } from "firebase/firestore";

        const firebaseConfig = {
            apiKey: "AIzaSyDRISQYFZ7sQuGpf4ImqW6hecP0zEnRyFY",
            authDomain: "concurseirorm-de747.firebaseapp.com",
            projectId: "concurseirorm-de747",
            storageBucket: "concurseirorm-de747.firebasestorage.app",
            messagingSenderId: "597777186067",
            appId: "1:597777186067:web:f475a5c33062de5f926ee6",
            measurementId: "G-VG1N8HQGHG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const loginModal = document.getElementById('loginModal');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const emailForm = document.getElementById('emailForm');
        const loginError = document.getElementById('loginError');
        const userHeader = document.getElementById('userHeader');
        const userAvatar = document.getElementById('userAvatar');
        const logoutBtn = document.getElementById('logoutBtn');
        const editalList = document.getElementById('editalList');
        const editaisCount = document.getElementById('editaisCount');

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginModal.classList.add('hidden');
                loginModal.classList.remove('flex'); // Remove flex to hide completely
                userHeader.classList.remove('hidden');
                userHeader.classList.add('flex');
                
                // Set Avatar Initial
                userAvatar.innerText = user.email ? user.email[0].toUpperCase() : 'U';
                window.currentUser = user;
                
                // Load saved editais
                window.loadEditaisFromFirestore();
            } else {
                loginModal.classList.remove('hidden');
                loginModal.classList.add('flex');
                userHeader.classList.add('hidden');
                userHeader.classList.remove('flex');
                window.currentUser = null;
                editalList.innerHTML = '<div class="text-center text-gray-500 mt-10"><p>Fa√ßa login para ver seus editais.</p></div>';
            }
        });

        // Google Login
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                loginError.innerText = error.message;
                loginError.classList.remove('hidden');
            }
        });

        // Email Login/Signup
        emailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            loginError.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                     try {
                        await createUserWithEmailAndPassword(auth, email, password);
                     } catch (createError) {
                        loginError.innerText = "Erro ao criar conta: " + createError.message;
                        loginError.classList.remove('hidden');
                     }
                } else {
                    loginError.innerText = "Erro no login: " + error.message;
                    loginError.classList.remove('hidden');
                }
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        window.saveGenerationToFirestore = async (text, action, result) => {
            if (!auth.currentUser) return;
            try {
                await addDoc(collection(db, "users", auth.currentUser.uid, "generations"), {
                    originalText: text.slice(0, 500) + "...",
                    action: action,
                    result: result,
                    createdAt: serverTimestamp()
                });
                console.log("Salvo no Firestore!");
            } catch (e) {
                console.error("Erro ao salvar:", e);
            }
        };

        // --- Edital Persistence ---

        window.saveEditalToFirestore = async (analysisData, fullText) => {
            if (!auth.currentUser) return;
            try {
                const editalData = {
                    nome_concurso: analysisData.nome_concurso || "Edital Sem Nome",
                    banca: analysisData.banca || "Desconhecida",
                    vagas: analysisData.vagas || "N/A",
                    analysis_json: JSON.stringify(analysisData),
                    full_text: fullText, // Note: Firestore doc limit 1MB. 
                    createdAt: serverTimestamp()
                };
                
                await addDoc(collection(db, "users", auth.currentUser.uid, "editais"), editalData);
                console.log("Edital salvo!");
                window.loadEditaisFromFirestore(); // Refresh list
            } catch (e) {
                console.error("Erro ao salvar edital:", e);
                alert("Erro ao salvar edital no hist√≥rico: " + e.message);
            }
        };

        window.loadEditaisFromFirestore = async () => {
            if (!auth.currentUser) return;
            
            editalList.innerHTML = '<div class="flex justify-center p-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div></div>';
            
            try {
                const q = query(collection(db, "users", auth.currentUser.uid, "editais"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                editalList.innerHTML = '';
                editaisCount.innerText = querySnapshot.size;

                if (querySnapshot.empty) {
                    editalList.innerHTML = '<div class="text-center text-gray-500 mt-10"><p>Nenhum edital salvo.</p></div>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const el = document.createElement('div');
                    el.className = "group relative bg-white/5 hover:bg-white/10 border border-white/5 rounded-xl p-3 cursor-pointer transition-all";
                    el.onclick = (e) => {
                         // Prevent click if delete button was clicked
                         if(e.target.closest('.delete-btn')) return;
                         window.loadEditalIntoDashboard(data, doc.id);
                    };
                    
                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-sm text-gray-200 truncate pr-6">${data.nome_concurso}</h3>
                                <p class="text-xs text-gray-400 mt-1">${data.banca} ‚Ä¢ ${data.vagas} vagas</p>
                            </div>
                            <button class="delete-btn opacity-0 group-hover:opacity-100 p-1.5 text-red-400 hover:bg-red-500/20 rounded-lg transition-all absolute top-2 right-2" onclick="window.deleteEditalFromFirestore('${doc.id}')">
                                üóëÔ∏è
                            </button>
                        </div>
                    `;
                    editalList.appendChild(el);
                });
            } catch (e) {
                console.error("Erro ao carregar editais:", e);
                editalList.innerHTML = '<div class="text-center text-red-400 p-4">Erro ao carregar.</div>';
            }
        };

        window.deleteEditalFromFirestore = async (docId) => {
            if (!confirm("Tem certeza que deseja excluir este edital?")) return;
            try {
                await deleteDoc(doc(db, "users", auth.currentUser.uid, "editais", docId));
                window.loadEditaisFromFirestore();
                
                // Clear dashboard if current edital is the one deleted (optional check)
                // For simplicity, we just leave the dashboard as is or reset
            } catch (e) {
                console.error("Erro ao excluir:", e);
                alert("Erro ao excluir edital.");
            }
        };

        window.loadEditalIntoDashboard = (data, docId) => {
            // Set global text
            window.currentEditalText = data.full_text;
            window.currentEditalId = docId; // Track current ID
            
            // Parse analysis data
            try {
                const analysis = JSON.parse(data.analysis_json);
                renderDashboard(analysis);
                
                // Highlight active item in list
                document.querySelectorAll('#editalList > div').forEach(div => div.classList.remove('border-blue-500', 'bg-blue-500/10'));
                // Note: It's hard to find the specific div without an ID, but it's fine for now.
                
                // Switch to overview tab
                switchTab('visao-geral');
                
                // Show toast or feedback
                console.log("Edital carregado:", analysis.nome_concurso);
            } catch (e) {
                console.error("Erro ao processar dados do edital:", e);
            }
        };

    </script>

    <script>
        // Fun√ß√£o para selecionar partes relevantes do texto e reduzir o tamanho do payload
        function getSmartContext(fullText, type = 'general') {
            const MAX_CHARS = 45000; 
            
            if (fullText.length <= MAX_CHARS) return fullText;

            console.log(`Otimizando texto para envio (${type})...`);

            if (type === 'metadados') {
                // Para metadados, o in√≠cio do edital √© o mais importante (Banca, Vagas, Datas)
                // Geralmente nas primeiras 20 p√°ginas.
                return fullText.substring(0, 20000) + "\n\n...[RESTANTE OMITIDO]...";
            }

            if (type === 'materias') {
                // Para mat√©rias, precisamos do CONTE√öDO PROGRAM√ÅTICO (quase sempre no final/anexos)
                // E um pouco do in√≠cio para contexto (nome do cargo)
                let smartText = fullText.substring(0, 2000); // Contexto b√°sico
                smartText += "\n\n...[MEIO OMITIDO]...\n\n";
                
                // Pega os √∫ltimos 35k caracteres (aumentado para garantir)
                const lastPart = fullText.substring(fullText.length - 35000);
                smartText += lastPart;
                
                // Se o texto total ainda for pequeno, podemos tentar buscar no meio
                // Mas geralmente 35k do final cobre os anexos.
                return smartText;
            }

            // Fallback (General / Quiz / Plano)
            // 1. Sempre pegar o in√≠cio (Cabe√ßalho, Banca, Vagas) - Primeiros 10k caracteres
            let smartText = fullText.substring(0, 10000);
            smartText += "\n\n...[TRECHO OMITIDO PELO SISTEMA]...\n\n";

            // 2. Procurar por se√ß√µes de Conte√∫do Program√°tico / Anexos
            const lastPart = fullText.substring(fullText.length - 25000);
            smartText += lastPart;

            console.log(`Texto original: ${fullText.length} chars. Texto otimizado: ${smartText.length} chars.`);
            return smartText;
        }

        // Custom Animation for Progress Bar
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes progress {
                0% { width: 0%; }
                50% { width: 70%; }
                100% { width: 90%; }
            }
            .animate-progress {
                animation: progress 15s ease-out forwards;
            }
            .animate-fade-in-up {
                animation: fadeInUp 0.5s ease-out forwards;
            }
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(styleSheet);

        let currentSimulado = null;
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let simuladoTimer = null;
        window.currentEditalText = null;

        window.currentEditalData = {};

        // Auto-trigger analysis on file upload
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Reset UI
            document.getElementById('contestDashboard').classList.add('hidden');
            document.getElementById('resultadoArea').classList.add('hidden');
            document.getElementById('simuladoArea').classList.add('hidden');
            window.currentEditalData = {}; // Reset Global Data
            
            // Show Loading
            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            statusDiv.classList.remove('hidden');
            statusText.innerText = "Lendo PDF...";
            
            try {
                window.currentEditalText = await extractTextFromPDF(file);
                
                // --- FASE 1: Metadados (R√°pido) ---
                statusText.innerText = "1/2: Identificando Banca e Vagas...";
                const metaData = await chamarBackend('analisar_metadados');
                
                if (metaData) {
                    window.currentEditalData = { ...window.currentEditalData, ...metaData };
                    renderDashboard(window.currentEditalData);
                }

                // --- Placeholder para FASE 2 ---
                const visaoGeralPanel = document.getElementById('panel-visao-geral');
                const loadingId = 'loading-conteudos-placeholder';
                if (!document.getElementById(loadingId)) {
                    visaoGeralPanel.insertAdjacentHTML('beforeend', `
                        <div id="${loadingId}" class="glass-card p-6 rounded-3xl border border-white/10 mt-6 animate-pulse">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-6 h-6 bg-blue-500/50 rounded-full animate-bounce"></div>
                                <div class="h-6 bg-gray-700 rounded w-1/3"></div>
                            </div>
                            <div class="space-y-3">
                                <div class="h-4 bg-gray-800 rounded w-3/4"></div>
                                <div class="h-4 bg-gray-800 rounded w-5/6"></div>
                                <div class="h-4 bg-gray-800 rounded w-1/2"></div>
                            </div>
                            <p class="text-center text-blue-300 mt-6 text-sm font-semibold">üîç IA lendo anexos e extraindo mat√©rias...</p>
                        </div>
                    `);
                }

                // --- FASE 2: Conte√∫do Program√°tico (Pesado) ---
                statusText.innerText = "2/2: Detalhando Mat√©rias e T√≥picos...";
                const contentData = await chamarBackend('analisar_materias');
                
                // Remove placeholder
                const placeholder = document.getElementById(loadingId);
                if(placeholder) placeholder.remove();

                if (contentData) {
                    window.currentEditalData = { ...window.currentEditalData, ...contentData };
                    renderDashboard(window.currentEditalData);
                    
                    // Salvar no Firestore apenas quando tiver tudo
                    if (window.saveEditalToFirestore) {
                        window.saveEditalToFirestore(window.currentEditalData, window.currentEditalText);
                    }
                    
                    // Show Success Feedback
                    finishAction(null, 'analisar_edital', null);
                }
                
                statusDiv.classList.add('hidden');
                
            } catch (error) {
                alert("Erro: " + error.message);
                statusDiv.classList.add('hidden');
                document.getElementById('fileInput').value = ''; // Reset input
            }
        }

        window.switchTab = (tabId) => {
            // Update Buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white', 'shadow-lg');
                btn.classList.add('text-gray-400');
            });
            const activeBtn = document.getElementById('tab-' + tabId);
            if(activeBtn) {
                activeBtn.classList.add('active', 'bg-blue-600', 'text-white', 'shadow-lg');
                activeBtn.classList.remove('text-gray-400');
            }

            // Show Panel
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden'));
            const panel = document.getElementById('panel-' + tabId);
            if(panel) panel.classList.remove('hidden');
            
            // Manage Result Areas visibility based on tab
            if (tabId === 'plano-estudos') {
                const resArea = document.getElementById('resultadoArea');
                if (resArea.innerHTML.trim() !== "") resArea.classList.remove('hidden');
            } else if (tabId === 'treino') {
                // Simulado area visibility depends if it's running
                if (document.getElementById('simuladoArea').querySelector('#questionText').innerText !== "") {
                     document.getElementById('simuladoArea').classList.remove('hidden');
                }
            } else {
                document.getElementById('resultadoArea').classList.add('hidden');
                document.getElementById('simuladoArea').classList.add('hidden');
            }
        };

        function renderDashboard(data) {
            if(data.nome_concurso) document.getElementById('dash-nome').innerText = data.nome_concurso;
            if(data.banca) document.getElementById('dash-banca').innerText = "Banca: " + data.banca;
            if(data.vagas) document.getElementById('dash-vagas').innerText = "Vagas: " + data.vagas;
            if(data.salario) document.getElementById('dash-salario').innerText = "R$ " + data.salario;

            if (data.etapas) {
                const etapasList = document.getElementById('dash-etapas');
                etapasList.innerHTML = '';
                (data.etapas || []).forEach(etapa => {
                    etapasList.innerHTML += `<li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span>${etapa}</li>`;
                });
            }

            if (data.resumo_materias) {
                const materiasDiv = document.getElementById('dash-materias');
                materiasDiv.innerHTML = '';
                (data.resumo_materias || []).forEach(mat => {
                    materiasDiv.innerHTML += `<span class="px-3 py-1 rounded-full bg-white/5 text-xs border border-white/10 hover:bg-white/10 transition-colors">${mat}</span>`;
                });
            }

            // Show Dashboard
            document.getElementById('contestDashboard').classList.remove('hidden');
            // Status is handled by handleFileUpload now

            // Render Conte√∫do Program√°tico if available
            if (data.conteudo_programatico) {
                // Remove existing if any
                const existing = document.getElementById('dash-conteudos');
                if (existing) existing.remove();

                const conteudosDiv = document.createElement('div');
                conteudosDiv.id = 'dash-conteudos';
                conteudosDiv.className = "glass-card p-6 rounded-3xl border border-white/10 mt-6";
                conteudosDiv.innerHTML = `<h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">üìë Conte√∫do Detalhado</h3>`;
                
                const list = document.createElement('div');
                list.className = "space-y-4";
                
                for (const [materia, topicos] of Object.entries(data.conteudo_programatico)) {
                    list.innerHTML += `
                        <div>
                            <h4 class="text-blue-400 font-semibold mb-1">${materia}</h4>
                            <p class="text-sm text-gray-400 leading-relaxed">${Array.isArray(topicos) ? topicos.join(', ') : topicos}</p>
                        </div>
                    `;
                }
                conteudosDiv.appendChild(list);
                document.getElementById('panel-visao-geral').appendChild(conteudosDiv);
            }
        }

        async function extractTextFromPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += `--- P√°gina ${i} ---\n${pageText}\n`;
                }
                
                console.log(`PDF processado: ${pdf.numPages} p√°ginas, ${fullText.length} caracteres.`);
                console.log("In√≠cio do texto extra√≠do:", fullText.substring(0, 200));

                if (fullText.length < 500) {
                    alert("Aten√ß√£o: O texto extra√≠do do PDF parece muito curto. Se o seu PDF for uma imagem digitalizada (scanned), a IA pode n√£o conseguir ler. Tente usar um PDF com texto selecion√°vel.");
                }

                return fullText;
            } catch (error) {
                console.error("Erro ao ler PDF:", error);
                throw new Error("Falha ao ler o arquivo PDF.");
            }
        }

        async function chamarBackend(acao) {
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('resultadoArea');
            const simuladoDiv = document.getElementById('simuladoArea');

            // Use cached text or check file input
            let text = window.currentEditalText;
            if (!text) {
                 const fileInput = document.getElementById('fileInput');
                 if (fileInput.files.length > 0) {
                     statusDiv.classList.remove('hidden');
                     document.getElementById('statusText').innerText = "Lendo PDF...";
                     text = await extractTextFromPDF(fileInput.files[0]);
                     window.currentEditalText = text;
                 } else {
                     alert("Nenhum edital carregado. Por favor, fa√ßa upload do PDF."); 
                     return;
                 }
            }
            
            // Otimiza o texto antes de enviar
            let type = 'general';
            if (acao === 'analisar_metadados') type = 'metadados';
            if (acao === 'analisar_materias') type = 'materias';
            const textToSend = getSmartContext(text, type);

            statusDiv.classList.remove('hidden');
            if(!acao.startsWith('analisar_')) {
                // If generating plan/quiz, we can keep dashboard visible but show loading
                document.getElementById('statusText').innerText = "Gerando conte√∫do...";
            }
            
            // Hide result areas temporarily while loading new content
            if (acao === 'plano') {
                document.getElementById('planoResult').classList.add('hidden');
                // Ensure tab is active
                switchTab('plano-estudos');
            }
            if (acao === 'simulado_real') simuladoDiv.classList.add('hidden');
            
            statusDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

            try {
                const response = await fetch('/.netlify/functions/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: textToSend,
                        action: acao,
                        topic: "Conhecimentos Espec√≠ficos"
                    })
                });

                if (!response.ok) {
                    let errorMsg = `Erro na API (${response.status})`;
                    const errorText = await response.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMsg = errorData.error || errorMsg;
                    } catch (e) {
                        if (errorText) errorMsg = errorText;
                    }
                    throw new Error(errorMsg);
                }

                if (acao.startsWith('analisar_') || acao === 'simulado_real') {
                    // Accumulate stream for JSON parsing
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullText = "";

                    console.log(`Iniciando leitura do stream para ${acao}...`);
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        fullText += chunk;
                    }

                    // Clean markdown JSON if present
                    let jsonStr = fullText;
                    
                    console.log("Raw Response:", jsonStr); // Debug Log

                    // Remove potential whitespace/newlines from start
                    jsonStr = jsonStr.trim();

                    // --- Robust JSON Extraction ---
                    // √Äs vezes a IA coloca texto antes ou depois do bloco de c√≥digo.
                    // Vamos tentar extrair apenas o conte√∫do entre a primeira { e a √∫ltima }
                    const firstBrace = jsonStr.indexOf('{');
                    const lastBrace = jsonStr.lastIndexOf('}');

                    if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                        jsonStr = jsonStr.substring(firstBrace, lastBrace + 1);
                    } else {
                        // Se n√£o achar chaves, tenta limpar markdown padr√£o
                        if (jsonStr.includes("```json")) {
                            jsonStr = jsonStr.replace(/```json/g, "").replace(/```/g, "");
                        } else if (jsonStr.includes("```")) {
                            jsonStr = jsonStr.replace(/```/g, "");
                        }
                    }
                    
                    let data;
                    try {
                        data = JSON.parse(jsonStr);
                    } catch (e) {
                        console.error("JSON Parse Error:", e);
                        console.error("Invalid JSON String:", jsonStr);
                        
                        // Fallback: Tentar corrigir JSON quebrado (comum em streams interrompidas)
                        // Ex: falta fechar aspas ou chaves no final
                        try {
                            // Tenta fechar aspas se estiver aberto
                            if ((jsonStr.match(/"/g) || []).length % 2 !== 0) {
                                jsonStr += '"';
                            }
                             // Tenta fechar chaves se faltar
                             const openBraces = (jsonStr.match(/{/g) || []).length;
                             const closeBraces = (jsonStr.match(/}/g) || []).length;
                             for(let i=0; i < (openBraces - closeBraces); i++) {
                                 jsonStr += "}";
                             }
                             data = JSON.parse(jsonStr);
                             console.warn("JSON recuperado automaticamente!");
                        } catch (e2) {
                            throw new Error("A IA retornou uma resposta inv√°lida. Tente novamente.");
                        }
                    }

                    if (acao.startsWith('analisar_')) {
                        // Retorna os dados para serem processados pelo caller (handleFileUpload)
                        return data;
                    } else {
                         // Move Simulado Area to Treino Panel
                        const panel = document.getElementById('panel-treino');
                        const simArea = document.getElementById('simuladoArea');
                        if (!panel.contains(simArea)) {
                            panel.appendChild(simArea);
                        }
                        startSimulado(data);
                        statusDiv.classList.add('hidden');
                    }
                } else {
                    // Fluxo normal (Markdown Stream - Plano/Quiz)
                    let targetDiv = resultDiv;
                    
                    if (acao === 'plano') {
                        targetDiv = document.getElementById('planoResult');
                    }
                    
                    console.log("Iniciando leitura do stream...");
                    targetDiv.innerHTML = '<div class="prose prose-invert prose-lg max-w-none prose-headings:text-blue-300 prose-a:text-blue-400 prose-strong:text-white"><p class="animate-pulse">Gerando...</p></div>';
                    const contentDiv = targetDiv.querySelector('div');
                    targetDiv.classList.remove('hidden');
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let markdown = "";

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        console.log("Chunk recebido:", chunk.length);
                        markdown += chunk;
                        contentDiv.innerHTML = marked.parse(markdown);
                    }
                    
                    if (!markdown) {
                        contentDiv.innerHTML = "<p class='text-red-400'>Nenhuma resposta gerada pela IA.</p>";
                    }

                    finishAction(text, acao, markdown);
                    statusDiv.classList.add('hidden');
                    targetDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

            } catch (error) {
                alert("Ops! " + error.message);
                statusDiv.classList.add('hidden');
            }
        }

        function finishAction(text, action, result) {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#3b82f6', '#8b5cf6', '#ec4899']
            });
            if (window.saveGenerationToFirestore) {
                window.saveGenerationToFirestore(text, action, result);
            }
        }

        // --- L√≥gica do Simulado ---

        function startSimulado(data) {
            currentSimulado = data;
            currentQuestionIndex = 0;
            userAnswers = {};
            
            document.getElementById('simuladoArea').classList.remove('hidden');
            document.getElementById('simuladoTitle').innerText = data.exam_config.title || "Simulado";
            document.getElementById('totalQuestionsNum').innerText = data.questions.length;
            
            // Timer
            const duration = (data.exam_config.duration_minutes || 240) * 60;
            startTimer(duration);

            renderQuestion();
            document.getElementById('simuladoArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function startTimer(durationSeconds) {
            if (simuladoTimer) clearInterval(simuladoTimer);
            let timer = durationSeconds;
            const display = document.getElementById('timerDisplay');
            
            simuladoTimer = setInterval(function () {
                let hours = parseInt(timer / 3600, 10);
                let minutes = parseInt((timer % 3600) / 60, 10);
                let seconds = parseInt(timer % 60, 10);

                hours = hours < 10 ? "0" + hours : hours;
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = hours > 0 ? `${hours}:${minutes}:${seconds}` : `${minutes}:${seconds}`;

                if (--timer < 0) {
                    clearInterval(simuladoTimer);
                    alert("Tempo esgotado!");
                    submitSimulado();
                }
            }, 1000);
        }

        function renderQuestion() {
            const q = currentSimulado.questions[currentQuestionIndex];
            
            document.getElementById('currentQuestionNum').innerText = currentQuestionIndex + 1;
            
            let subjectText = q.subject || "Geral";
            if (q.difficulty) subjectText += ` ‚Ä¢ ${q.difficulty}`;
            document.getElementById('simuladoSubject').innerText = subjectText;
            
            document.getElementById('questionText').innerText = q.question;
            
            const optsContainer = document.getElementById('optionsContainer');
            optsContainer.innerHTML = '';

            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left p-4 rounded-xl border transition-all ${
                    userAnswers[currentQuestionIndex] === idx 
                    ? 'bg-blue-600/20 border-blue-500 text-white' 
                    : 'bg-gray-800/50 border-gray-700 hover:bg-gray-700 text-gray-300'
                }`;
                btn.innerHTML = `<span class="font-bold mr-3">${String.fromCharCode(65+idx)})</span> ${opt}`;
                btn.onclick = () => selectOption(idx);
                optsContainer.appendChild(btn);
            });

            // Nav Buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            const isLast = currentQuestionIndex === currentSimulado.questions.length - 1;
            document.getElementById('nextBtn').classList.toggle('hidden', isLast);
            document.getElementById('submitSimuladoBtn').classList.toggle('hidden', !isLast);
        }

        function selectOption(idx) {
            userAnswers[currentQuestionIndex] = idx;
            renderQuestion(); // Re-render to show selection
        }

        document.getElementById('prevBtn').onclick = () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        };

        document.getElementById('nextBtn').onclick = () => {
            if (currentQuestionIndex < currentSimulado.questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        };

        document.getElementById('submitSimuladoBtn').onclick = submitSimulado;

        function submitSimulado() {
            if (simuladoTimer) clearInterval(simuladoTimer);
            
            let score = 0;
            let reportHtml = `
                <h2 class="text-3xl font-bold mb-6 text-center">Resultado do Simulado</h2>
                <div class="space-y-6">
            `;

            currentSimulado.questions.forEach((q, idx) => {
                const userAnswer = userAnswers[idx];
                const isCorrect = userAnswer === q.correct_option_index;
                if (isCorrect) score++;

                reportHtml += `
                    <div class="p-6 rounded-xl border ${isCorrect ? 'bg-green-900/20 border-green-500/50' : 'bg-red-900/20 border-red-500/50'}">
                        <div class="flex justify-between mb-2">
                            <span class="font-bold text-sm text-gray-400">Quest√£o ${idx + 1} - ${q.subject}</span>
                            <span class="font-bold ${isCorrect ? 'text-green-400' : 'text-red-400'}">
                                ${isCorrect ? 'Acertou! ‚úÖ' : 'Errou ‚ùå'}
                            </span>
                        </div>
                        <p class="mb-4 text-white">${q.question}</p>
                        <p class="text-sm text-gray-300 mb-1">Sua resposta: <span class="font-bold">${userAnswer !== undefined ? String.fromCharCode(65+userAnswer) : '-'}</span></p>
                        <p class="text-sm text-green-400 mb-2">Correta: <span class="font-bold">${String.fromCharCode(65+q.correct_option_index)}</span></p>
                        <div class="bg-gray-900/50 p-3 rounded-lg text-sm text-gray-400 mt-3">
                            <strong>Explica√ß√£o:</strong> ${q.explanation}
                        </div>
                    </div>
                `;
            });

            reportHtml += `</div>`;
            
            // Score Summary at top
            const percentage = Math.round((score / currentSimulado.questions.length) * 100);
            const summaryHtml = `
                <div class="text-center mb-8 p-6 bg-gray-800 rounded-2xl border border-gray-700">
                    <div class="text-6xl mb-2">${percentage >= 70 ? 'üéâ' : 'üìö'}</div>
                    <div class="text-4xl font-bold text-white mb-2">${score}/${currentSimulado.questions.length}</div>
                    <div class="text-xl ${percentage >= 70 ? 'text-green-400' : 'text-yellow-400'} font-bold">
                        ${percentage}% de Aproveitamento
                    </div>
                </div>
            `;

            const resultDiv = document.getElementById('resultadoArea');
            resultDiv.innerHTML = '<div class="prose prose-invert prose-lg max-w-none">' + summaryHtml + reportHtml + '</div>';
            resultDiv.classList.remove('hidden');
            document.getElementById('simuladoArea').classList.add('hidden');
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

            finishAction(JSON.stringify(currentSimulado), "simulado_completed", `Score: ${score}/${currentSimulado.questions.length}`);
        }
    </script>
</body>
</html>