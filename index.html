<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edital App V2 | Gamified</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    },
                    typography: (theme) => ({
                        invert: {
                            css: {
                                '--tw-prose-body': theme('colors.gray[300]'),
                                '--tw-prose-headings': theme('colors.white'),
                                '--tw-prose-links': theme('colors.blue[400]'),
                                '--tw-prose-bold': theme('colors.white'),
                                '--tw-prose-counters': theme('colors.blue[400]'),
                                '--tw-prose-bullets': theme('colors.blue[400]'),
                                '--tw-prose-hr': theme('colors.gray[700]'),
                                '--tw-prose-quotes': theme('colors.gray[100]'),
                                '--tw-prose-quote-borders': theme('colors.blue[500]'),
                                '--tw-prose-th-borders': theme('colors.gray[600]'),
                                '--tw-prose-td-borders': theme('colors.gray[700]'),
                            },
                        },
                    }),
                }
            },
            plugins: [
                function({ addComponents }) {
                    addComponents({
                        '.glass': {
                            'background': 'rgba(255, 255, 255, 0.05)',
                            'backdrop-filter': 'blur(10px)',
                            'border': '1px solid rgba(255, 255, 255, 0.1)',
                        },
                        '.glass-card': {
                            'background': 'rgba(17, 24, 39, 0.7)',
                            'backdrop-filter': 'blur(20px)',
                            'border': '1px solid rgba(255, 255, 255, 0.05)',
                        }
                    })
                }
            ]
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script type="importmap">
      {
        "imports": {
          "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
          "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"
        }
      }
    </script>
    <style>
        body { font-family: 'Outfit', sans-serif; }
    </style>
</head>
<body class="bg-[#0f172a] text-gray-100 min-h-screen relative overflow-x-hidden selection:bg-purple-500 selection:text-white">

    <!-- Background Elements -->
    <div class="fixed inset-0 z-0 overflow-hidden pointer-events-none">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-8 left-1/3 w-96 h-96 bg-pink-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-all duration-500">
        <div class="glass-card p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-100 border-t border-white/10">
            <div class="text-center mb-8">
                <div class="inline-block p-3 rounded-full bg-blue-500/10 mb-4">
                    <span class="text-4xl">ðŸš€</span>
                </div>
                <h2 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">Bem-vindo</h2>
                <p class="text-gray-400 mt-2">Sua jornada rumo Ã  aprovaÃ§Ã£o comeÃ§a aqui.</p>
            </div>
            
            <button id="googleLoginBtn" class="w-full bg-white hover:bg-gray-50 text-gray-900 font-bold py-3.5 px-4 rounded-xl mb-6 flex items-center justify-center gap-3 transition-all hover:scale-[1.02] shadow-lg shadow-white/5">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                Continuar com Google
            </button>

            <div class="relative my-8">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-700"></div></div>
                <div class="relative flex justify-center text-xs uppercase tracking-widest"><span class="px-3 bg-[#131b2e] text-gray-500">Ou entre com email</span></div>
            </div>

            <form id="emailForm" class="space-y-4">
                <div class="group">
                    <input type="email" id="emailInput" placeholder="seu@email.com" class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3.5 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all" required>
                </div>
                <div>
                    <input type="password" id="passwordInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3.5 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all" required>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-blue-900/30 hover:shadow-blue-900/50 transition-all hover:scale-[1.02]">
                    Entrar / Criar Conta
                </button>
            </form>
            <p id="loginError" class="text-red-400 text-sm mt-4 text-center hidden bg-red-900/20 py-2 rounded-lg border border-red-900/30"></p>
        </div>
    </div>

    <!-- App Container -->
    <div class="relative z-10 max-w-5xl mx-auto pt-6 pb-20 px-4">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-12 glass rounded-2xl p-4 sticky top-4 z-40 shadow-xl shadow-black/20 transition-all duration-300">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xl shadow-lg">
                    ðŸ“š
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Edital App</h1>
                    <span class="text-xs text-blue-400 font-medium tracking-wide">V2.0 PRO</span>
                </div>
            </div>

            <!-- User Stats (Gamification) -->
            <div id="userHeader" class="hidden flex items-center gap-6">
                <div class="hidden md:flex items-center gap-4 bg-gray-800/50 px-4 py-2 rounded-xl border border-white/5">
                    <div class="flex flex-col items-end">
                        <span class="text-xs text-gray-400 uppercase tracking-wider">NÃ­vel 1</span>
                        <div class="w-24 h-1.5 bg-gray-700 rounded-full mt-1 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-yellow-400 to-orange-500 w-[30%]"></div>
                        </div>
                    </div>
                    <div class="w-px h-8 bg-gray-700"></div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400">XP</div>
                        <div class="font-bold text-yellow-400">350</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-xs font-bold ring-2 ring-gray-900" id="userAvatar">U</div>
                    <button id="logoutBtn" class="text-sm text-gray-400 hover:text-white transition-colors">Sair</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="space-y-8">
            
            <!-- Upload Section -->
            <section class="glass-card rounded-3xl p-1 text-center relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 opacity-50 group-hover:opacity-100 transition-opacity"></div>
                
                <div class="p-8 sm:p-12">
                    <h2 class="text-3xl sm:text-4xl font-bold mb-4">O que vamos estudar hoje?</h2>
                    <p class="text-gray-400 mb-8 max-w-lg mx-auto">FaÃ§a upload do seu edital em PDF e deixe nossa IA criar um plano de estudos personalizado ou um quiz desafiador.</p>
                    
                    <div class="max-w-xl mx-auto relative group/input">
                        <input type="file" id="fileInput" accept="application/pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                        <div class="border-2 border-dashed border-gray-600 rounded-2xl p-8 transition-all group-hover/input:border-blue-500 group-hover/input:bg-blue-500/5">
                            <div class="flex flex-col items-center gap-3">
                                <div class="w-16 h-16 rounded-full bg-gray-800 flex items-center justify-center mb-2 group-hover/input:scale-110 transition-transform">
                                    <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                </div>
                                <span class="font-semibold text-lg text-gray-200">Arraste seu PDF aqui</span>
                                <span class="text-sm text-gray-500">ou clique para selecionar</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
                        <button onclick="chamarBackend('plano')" class="group relative px-8 py-4 bg-gray-800 rounded-xl overflow-hidden transition-all hover:scale-105 hover:shadow-lg hover:shadow-green-900/30 border border-gray-700 hover:border-green-500/50">
                            <div class="absolute inset-0 w-full h-full bg-gradient-to-br from-green-600/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="relative flex items-center gap-3">
                                <span class="text-2xl">ðŸ“…</span>
                                <div class="text-left">
                                    <div class="font-bold text-white">Criar Plano</div>
                                    <div class="text-xs text-gray-400">Organize sua semana</div>
                                </div>
                            </div>
                        </button>

                        <button onclick="chamarBackend('quiz')" class="group relative px-8 py-4 bg-gray-800 rounded-xl overflow-hidden transition-all hover:scale-105 hover:shadow-lg hover:shadow-purple-900/30 border border-gray-700 hover:border-purple-500/50">
                            <div class="absolute inset-0 w-full h-full bg-gradient-to-br from-purple-600/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="relative flex items-center gap-3">
                                <span class="text-2xl">ðŸ§ </span>
                                <div class="text-left">
                                    <div class="font-bold text-white">Desafio Quiz</div>
                                    <div class="text-xs text-gray-400">Teste seus conhecimentos</div>
                                </div>
                            </div>
                        </button>
                    </div>

                    <!-- Loading State -->
                    <div id="status" class="hidden mt-8 max-w-md mx-auto">
                        <div class="flex justify-between text-sm text-blue-300 mb-2">
                            <span>Processando Edital...</span>
                            <span class="animate-pulse">IA trabalhando</span>
                        </div>
                        <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500 animate-progress w-full origin-left-right"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section id="resultadoArea" class="hidden glass-card rounded-3xl p-8 sm:p-12 border border-white/10 shadow-2xl animate-fade-in-up">
                <div class="prose prose-invert prose-lg max-w-none prose-headings:text-blue-300 prose-a:text-blue-400 prose-strong:text-white">
                    <!-- Markdown content goes here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Existing Scripts preserved and enhanced -->
    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "firebase/auth";
        import { getFirestore, collection, addDoc, serverTimestamp } from "firebase/firestore";

        const firebaseConfig = {
            apiKey: "AIzaSyDRISQYFZ7sQuGpf4ImqW6hecP0zEnRyFY",
            authDomain: "concurseirorm-de747.firebaseapp.com",
            projectId: "concurseirorm-de747",
            storageBucket: "concurseirorm-de747.firebasestorage.app",
            messagingSenderId: "597777186067",
            appId: "1:597777186067:web:f475a5c33062de5f926ee6",
            measurementId: "G-VG1N8HQGHG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const loginModal = document.getElementById('loginModal');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const emailForm = document.getElementById('emailForm');
        const loginError = document.getElementById('loginError');
        const userHeader = document.getElementById('userHeader');
        const userAvatar = document.getElementById('userAvatar');
        const logoutBtn = document.getElementById('logoutBtn');

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginModal.classList.add('hidden');
                loginModal.classList.remove('flex'); // Remove flex to hide completely
                userHeader.classList.remove('hidden');
                userHeader.classList.add('flex');
                
                // Set Avatar Initial
                userAvatar.innerText = user.email ? user.email[0].toUpperCase() : 'U';
                window.currentUser = user;
            } else {
                loginModal.classList.remove('hidden');
                loginModal.classList.add('flex');
                userHeader.classList.add('hidden');
                userHeader.classList.remove('flex');
                window.currentUser = null;
            }
        });

        // Google Login
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                loginError.innerText = error.message;
                loginError.classList.remove('hidden');
            }
        });

        // Email Login/Signup
        emailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            loginError.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                     try {
                        await createUserWithEmailAndPassword(auth, email, password);
                     } catch (createError) {
                        loginError.innerText = "Erro ao criar conta: " + createError.message;
                        loginError.classList.remove('hidden');
                     }
                } else {
                    loginError.innerText = "Erro no login: " + error.message;
                    loginError.classList.remove('hidden');
                }
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        window.saveGenerationToFirestore = async (text, action, result) => {
            if (!auth.currentUser) return;
            try {
                await addDoc(collection(db, "users", auth.currentUser.uid, "generations"), {
                    originalText: text.slice(0, 500) + "...",
                    action: action,
                    result: result,
                    createdAt: serverTimestamp()
                });
                console.log("Salvo no Firestore!");
            } catch (e) {
                console.error("Erro ao salvar:", e);
            }
        };
    </script>

    <script>
        // Custom Animation for Progress Bar
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes progress {
                0% { width: 0%; }
                50% { width: 70%; }
                100% { width: 90%; }
            }
            .animate-progress {
                animation: progress 15s ease-out forwards;
            }
            .animate-fade-in-up {
                animation: fadeInUp 0.5s ease-out forwards;
            }
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(styleSheet);

        async function extractTextFromPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += `--- PÃ¡gina ${i} ---\n${pageText}\n`;
                }
                return fullText;
            } catch (error) {
                console.error("Erro ao ler PDF:", error);
                throw new Error("Falha ao ler o arquivo PDF.");
            }
        }

        async function chamarBackend(acao) {
            const fileInput = document.getElementById('fileInput');
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('resultadoArea');

            if (fileInput.files.length === 0) { 
                // Shake animation for error
                fileInput.parentElement.classList.add('animate-bounce');
                setTimeout(() => fileInput.parentElement.classList.remove('animate-bounce'), 1000);
                alert("Por favor, arraste ou selecione um PDF primeiro!"); 
                return; 
            }

            statusDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            
            // Scroll to status
            statusDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

            try {
                const text = await extractTextFromPDF(fileInput.files[0]);

                const response = await fetch('/.netlify/functions/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        action: acao,
                        topic: "Conhecimentos EspecÃ­ficos"
                    })
                });

                if (!response.ok) {
                    let errorMsg = `Erro na API (${response.status})`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error || errorMsg;
                    } catch (e) {
                        const textErr = await response.text();
                        if (textErr) errorMsg = textErr;
                    }
                    throw new Error(errorMsg);
                }

                resultDiv.innerHTML = '<div class="prose prose-invert prose-lg max-w-none prose-headings:text-blue-300 prose-a:text-blue-400 prose-strong:text-white"></div>';
                const contentDiv = resultDiv.querySelector('div');
                
                resultDiv.classList.remove('hidden');
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let markdown = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    markdown += chunk;
                    contentDiv.innerHTML = marked.parse(markdown);
                }

                // Success! Fire confetti
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#3b82f6', '#8b5cf6', '#ec4899']
                });

                // Scroll to results
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

                if (window.saveGenerationToFirestore) {
                    window.saveGenerationToFirestore(text, acao, markdown);
                }

            } catch (error) {
                alert("Ops! " + error.message);
            } finally {
                statusDiv.classList.add('hidden');
            }
        }
    </script>
</body>
</html>