<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edital App V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script type="importmap">
      {
        "imports": {
          "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
          "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"
        }
      }
    </script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-8 relative">

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md border border-gray-700">
            <h2 class="text-3xl font-bold mb-6 text-center text-blue-500">ConcurseiroRM</h2>
            <p class="text-gray-400 text-center mb-8">Fa√ßa login para salvar seus estudos</p>
            
            <button id="googleLoginBtn" class="w-full bg-white hover:bg-gray-100 text-gray-900 font-bold py-3 px-4 rounded mb-4 flex items-center justify-center gap-2 transition-colors">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6" alt="Google">
                Entrar com Google
            </button>

            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-600"></div></div>
                <div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-800 text-gray-500">Ou use email</span></div>
            </div>

            <form id="emailForm" class="space-y-4">
                <div>
                    <input type="email" id="emailInput" placeholder="Seu E-mail" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white focus:outline-none focus:border-blue-500" required>
                </div>
                <div>
                    <input type="password" id="passwordInput" placeholder="Sua Senha" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white focus:outline-none focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition-colors">
                    Entrar / Cadastrar
                </button>
            </form>
            <p id="loginError" class="text-red-500 text-sm mt-4 text-center hidden"></p>
        </div>
    </div>

    <!-- User Header (Hidden initially) -->
    <div id="userHeader" class="hidden absolute top-4 right-4 flex items-center gap-4">
        <span id="userEmail" class="text-gray-400 text-sm"></span>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-2 px-3 rounded">Sair</button>
    </div>

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center text-blue-500">Edital App V2.0 üöÄ</h1>

        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6 border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-blue-400">1. Carregar Edital</h2>
            <input type="file" id="fileInput" accept="application/pdf" class="block w-full text-sm text-gray-400
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-blue-600 file:text-white
                hover:file:bg-blue-700
            "/>
            
            <div class="flex gap-4 mt-4">
                <button onclick="chamarBackend('plano')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded transition-colors">
                    üìÑ Gerar Plano de Estudos
                </button>
                <button onclick="chamarBackend('quiz')" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded transition-colors">
                    ‚ùì Gerar Quiz Surpresa
                </button>
            </div>
            <div id="status" class="mt-3 text-center text-yellow-400 hidden">Processando...</div>
        </div>

        <div id="resultadoArea" class="hidden bg-gray-800 p-8 rounded-lg shadow-lg border border-gray-700 prose prose-invert max-w-none"></div>
    </div>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "firebase/auth";
        import { getFirestore, collection, addDoc, serverTimestamp } from "firebase/firestore";

        const firebaseConfig = {
            apiKey: "AIzaSyDRISQYFZ7sQuGpf4ImqW6hecP0zEnRyFY",
            authDomain: "concurseirorm-de747.firebaseapp.com",
            projectId: "concurseirorm-de747",
            storageBucket: "concurseirorm-de747.firebasestorage.app",
            messagingSenderId: "597777186067",
            appId: "1:597777186067:web:f475a5c33062de5f926ee6",
            measurementId: "G-VG1N8HQGHG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const loginModal = document.getElementById('loginModal');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const emailForm = document.getElementById('emailForm');
        const loginError = document.getElementById('loginError');
        const userHeader = document.getElementById('userHeader');
        const userEmailSpan = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                loginModal.classList.add('hidden');
                userHeader.classList.remove('hidden');
                userEmailSpan.innerText = user.email;
                window.currentUser = user; // Expose for other scripts
            } else {
                // User is signed out
                loginModal.classList.remove('hidden');
                userHeader.classList.add('hidden');
                window.currentUser = null;
            }
        });

        // Google Login
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                loginError.innerText = error.message;
                loginError.classList.remove('hidden');
            }
        });

        // Email Login/Signup
        emailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            loginError.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                // If user not found, try to create account
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                     try {
                        await createUserWithEmailAndPassword(auth, email, password);
                     } catch (createError) {
                        loginError.innerText = "Erro ao criar conta: " + createError.message;
                        loginError.classList.remove('hidden');
                     }
                } else {
                    loginError.innerText = "Erro no login: " + error.message;
                    loginError.classList.remove('hidden');
                }
            }
        });

        // Logout
        logoutBtn.addEventListener('click', () => signOut(auth));

        // Expose Firestore Save Function
        window.saveGenerationToFirestore = async (text, action, result) => {
            if (!auth.currentUser) return;
            try {
                await addDoc(collection(db, "users", auth.currentUser.uid, "generations"), {
                    originalText: text.slice(0, 500) + "...", // Save snippet
                    action: action,
                    result: result,
                    createdAt: serverTimestamp()
                });
                console.log("Salvo no Firestore!");
            } catch (e) {
                console.error("Erro ao salvar:", e);
            }
        };
    </script>

    <script>
        async function extractTextFromPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += `--- P√°gina ${i} ---\n${pageText}\n`;
                }
                return fullText;
            } catch (error) {
                console.error("Erro ao ler PDF:", error);
                throw new Error("Falha ao ler o arquivo PDF.");
            }
        }

        async function chamarBackend(acao) {
            const fileInput = document.getElementById('fileInput');
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('resultadoArea');

            if (fileInput.files.length === 0) { alert("Selecione um PDF primeiro!"); return; }

            statusDiv.classList.remove('hidden');
            statusDiv.innerText = "Lendo PDF e consultando a IA...";
            resultDiv.classList.add('hidden');

            try {
                // 1. Extrai texto no navegador (economiza banda do servidor)
                const text = await extractTextFromPDF(fileInput.files[0]);

                // 2. Chama SUA fun√ß√£o Python no Netlify
                const response = await fetch('/.netlify/functions/api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        action: acao,
                        topic: "Conhecimentos Espec√≠ficos"
                    })
                });

                if (!response.ok) {
                    let errorMsg = `Erro na API (${response.status})`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error || errorMsg;
                    } catch (e) {
                        const textErr = await response.text();
                        if (textErr) errorMsg = textErr;
                    }
                    throw new Error(errorMsg);
                }

                // 3. Renderiza Stream
                resultDiv.innerHTML = "";
                resultDiv.classList.remove('hidden');
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let markdown = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    markdown += chunk;
                    resultDiv.innerHTML = marked.parse(markdown);
                }

                // Salvar no Firestore
                if (window.saveGenerationToFirestore) {
                    window.saveGenerationToFirestore(text, acao, markdown);
                }

            } catch (error) {
                alert("Erro: " + error.message);
            } finally {
                statusDiv.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
